(function(r,g){typeof exports=="object"&&typeof module<"u"?g(exports):typeof define=="function"&&define.amd?define(["exports"],g):(r=typeof globalThis<"u"?globalThis:r||self,g(r["yamjs-core"]={}))})(this,function(r){"use strict";const g=Java.type("org.bukkit.Bukkit"),p=g.getPluginManager(),y=p.getPlugin(Yam.getConfig().pluginName),N=g.getServer(),m=Java.type("java.lang.Runtime"),u=Java.type("java.lang.System"),C=e=>Object.keys(e).reduce((t,o)=>{var i;const a=e[o];return t[o]=(i=a==null?void 0:a.toString)==null?void 0:i.call(a),t},{}),z=()=>{const e=Java.type("java.lang.Long"),n=Java.type("org.bukkit.Bukkit"),t=n.getPluginManager().getPlugin("YamJS").getDataFolder().getParentFile().getParentFile(),o=n.getPluginManager().getPlugins().map(i=>i.getName());return{yamJS:{coreVersion:"0.0.1",pluginVersion:"0.0.1",legacyVersion:"0.0.1",instance:C(Yam.instance)},server:{players:`${n.getOnlinePlayers().size()} / ${n.getMaxPlayers()}`,plugins:o,minecraftVersion:n.getVersion(),bukkitVersion:n.getBukkitVersion(),onlineMode:n.getOnlineMode()},java:{version:u.getProperty("java.version"),vendor:u.getProperty("java.vendor"),vendorUrl:u.getProperty("java.vendor.url"),home:u.getProperty("java.home"),command:u.getProperty("sun.java.command"),timezone:u.getProperty("user.timezone")},system:{os:{name:u.getProperty("os.name"),version:u.getProperty("os.version"),arch:u.getProperty("os.arch")},cpu:{cores:m.getRuntime().availableProcessors()},memory:{free:m.getRuntime().freeMemory(),max:m.getRuntime().maxMemory()==e.MAX_VALUE?"unlimited":m.getRuntime().maxMemory(),total:m.getRuntime().totalMemory()},storage:{free:t==null?void 0:t.getFreeSpace(),total:t==null?void 0:t.getTotalSpace(),usable:t==null?void 0:t.getUsableSpace()}}}};let M={};"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".split("").forEach(function(e,n){M[e]=n});function O(e){let n=[],s=0,t=0;for(let o=0;o<e.length;o+=1){let a=M[e[o]];if(a===void 0)throw new Error("Invalid character ("+e[o]+")");const i=a&32;if(a&=31,t+=a<<s,i)s+=5;else{const c=t&1;t>>>=1,c?n.push(t===0?-2147483648:-t):n.push(t),t=s=0}}return n}function A(e){const s=e.mappings.split(";").map(t=>t.split(",")).map(t=>t.map(o=>O(o)));return{sources:e.sources,mappings:s,startOffset:0}}function H(e){const n=JSON.parse(e);return A(n)}const T=new Map;function V(e,n,s){const t=H(n);return t?(t.startOffset=s,T.set(e,t),!0):!1}function _({mappings:e,sources:n},s){let t=0,o=0,a=0;for(let i=0;i<e.length;i++)if(e[i].forEach(l=>{t+=l[2]??0,o+=l[1]??0}),i+1===s)return a=t+1,{file:n[o],line:a};throw new Error(`source map failed for line ${s}`)}function U(e,n){const s=T.get(`${e}`);if(s){if(n-=s.startOffset,n<=0)return{file:e,line:n};const t=_(s,n);return t.file.startsWith("webpack://test/")&&(t.file=t.file.replace("webpack://test/","")),t.file.startsWith("../")&&(t.file=t.file.replace("../","./")),t}else return{file:e,line:n}}const E=Java.type("org.bukkit.Bukkit"),B=Java.type("net.kyori.adventure.text.minimessage.MiniMessage"),S="      ",D=["yamjs.Interop.catchError","com.oracle.truffle.polyglot.PolyglotFunctionProxyHandler.invoke","jdk.proxy1.$Proxy75.run"],R=["webpack/runtime/make"],W=["catchAndLogUnhandledErrors"],G=e=>{const n=[];n.push(e.name);for(let s=0;s<e.stack.length;s++){const t=e.stack[s];if(t.javaFrame){if(D.includes(`${t.source}.${t.methodName}`))continue;n.push(`${S}at ${t.source}.${t.methodName}(${t.fileName}:${t.line})`);continue}const o=U(t.source,t.line);if(R.some(i=>o.file.includes(i))||W.includes(t.methodName)||o.line===0)continue;let a=t.methodName||"<anonymous>";t.methodName===":=>"&&(a="<anonymous>"),n.push(`${S}at ${a} (${o.file}:${o.line}) [${t.source}:${t.line}]`)}return n.join(`
`)},f=(e,n)=>{var t,o,a;let s;try{const i=((a=(o=(t=e==null?void 0:e.getClass)==null?void 0:t.call(e))==null?void 0:o.getName)==null?void 0:a.call(o))??void 0;i!=null&&i.includes("yamjs.JsError")?s=e:s=__interop.catchError(()=>{throw e});const c=G(s);n&&E.getConsoleSender().sendMessage(n),E.getConsoleSender().sendMessage(B.miniMessage().deserialize(`<red>${c}</red>`))}catch(i){console.log("ERROR: There was an error logging an error. Please report to YamJS. ",i.name),console.log(i.message,i.stack),console.log("Original error: ",e==null?void 0:e.name),console.log(e==null?void 0:e.message,e==null?void 0:e.stack)}},P=(e,n)=>{try{return e()}catch(s){f(s,n)}},X=(e,n)=>(...s)=>{try{return e(...s)}catch(t){f(t,n)}},q=Java.type("org.bukkit.event.EventPriority"),K=Java.type("org.bukkit.event.Listener"),I=()=>new(Java.extend(K,{})),L=I(),Q=(e,n,s="HIGHEST",t=L)=>{const o={priority:"priority"in n?n.priority:s,script:"script"in n?n.script:n},a=e.class.toString();p.registerEvent(e.class,t,q.valueOf(o.priority),(i,c)=>{c instanceof e&&P(()=>{o.script(c)},`An error occured while attempting to handle the "${a}" event!`)},y)};let h;const Z=(...e)=>{h===void 0&&(h=Yam.getConfig().verbose),h&&console.log(...e)},$=Symbol("TickContext"),ee=()=>{const e=k[$];if(e.isActive){for(const n of e.tickFns)n(e.tick);e.tick%20===0&&Z("Tick",e.tick),e.tick+=1}},k=(()=>{const e={tick:0,task:void 0,isActive:!1,tickFns:[]},n=()=>{e.isActive=!0,Yam.instance.setTickFn(ee)},s=async()=>{e.isActive=!1};return{[$]:e,start:n,stop:s,getTick:()=>e.tick,registerTickFn:t=>{e.tickFns.push(t)}}})(),te=e=>e,ne=e=>e,v=(()=>{const e={nextId:0},n=new Map,s=i=>{n.delete(i)},t=(i,c,l)=>{const d=ne((l==null?void 0:l.nextId)??e.nextId++),ce=te(k.getTick()+Math.max(c,1));return n.set(d,{baseTick:c,tick:ce,fn:i,reset:(l==null?void 0:l.reset)||!1,id:d}),d},o=i=>{n.delete(i.id),i.fn(),i.reset&&t(i.fn,i.baseTick,{reset:i.reset,nextId:i.id})},a=i=>{for(const[,c]of n)i>=c.tick&&o(c)};return{add:t,run:a,remove:s,initialize:()=>{k.registerTickFn(i=>a(i))}}})(),j=(e,n,s)=>{const t=n/50;return v.add(X(e,"Unhandled timer"),t,s)},w=(e,n)=>j(e,n),ie=(e,n)=>j(e,n,{reset:!0}),se=e=>w(e,0),x=e=>v.remove(e),oe=()=>{globalThis.setTimeout=w,globalThis.setInterval=ie,globalThis.setImmediate=se,globalThis.clearTimeout=x,globalThis.clearInterval=x},ae=Symbol("lifecycle"),b=(()=>{const e=new Map;let n=0;const s=async t=>{const o=new Map({...e.get(t)});for(let a=1;a<=5;a++){const i=[...o.values()].filter(c=>c.priority===a);for(const{hook:c,name:l}of i){l&&console.log(`Executing ${l}`);try{await(c==null?void 0:c())}catch(d){console.error(d)}}}e.delete(t)};return Yam.instance.setOnCloseFn(async()=>{await s("onDisable")}),{[ae]:{executeHooks:s},reload:async()=>{await s("onDisable"),Yam.reload()},register:(t,o)=>{const a=n++,i=e.get(t)??new Map;return i.set(a,o),e.set(t,i),()=>delete i[a]}}})(),J=Java.type("org.bukkit.event.HandlerList");let F=!1;const Y=()=>{F||(k.start(),v.initialize(),oe(),Yam.instance.setLoggerFn(e=>f(e)),Yam.getMeta()==="yamjs"?b.register("onDisable",{name:"Event Listeners",hook:()=>{J.unregisterAll(y)},priority:5}):b.register("onDisable",{name:"Context Event Listeners",hook:()=>{J.unregisterAll(L)},priority:5}),F=!0)};Yam.getConfig().initialize&&Y(),r.bukkitManager=p,r.bukkitPlugin=y,r.bukkitServer=N,r.cacheSourceMap=V,r.catchAndLogUnhandledError=P,r.createEventListener=I,r.getDebugInfo=z,r.initialize=Y,r.lifecycle=b,r.logError=f,r.registerEvent=Q,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
