(function(r,g){typeof exports=="object"&&typeof module<"u"?g(exports):typeof define=="function"&&define.amd?define(["exports"],g):(r=typeof globalThis<"u"?globalThis:r||self,g(r["yamjs-core"]={}))})(this,function(r){"use strict";const g=Java.type("org.bukkit.Bukkit"),h=g.getPluginManager(),f=h.getPlugin(Yam.getConfig().pluginName),z=g.getServer(),m=Java.type("java.lang.Runtime"),u=Java.type("java.lang.System"),H=e=>Object.keys(e).reduce((t,a)=>{var s;const o=e[a];return t[a]=(s=o==null?void 0:o.toString)==null?void 0:s.call(o),t},{}),O=()=>{const e=Java.type("java.lang.Long"),n=Java.type("org.bukkit.Bukkit"),i=f.getDataFolder().getParentFile().getParentFile(),t=n.getPluginManager().getPlugins().map(o=>o.getName());return{yamJS:{coreVersion:"0.0.1",pluginVersion:"0.0.1",legacyVersion:"0.0.1",instance:H(Yam.instance)},server:{players:`${n.getOnlinePlayers().size()} / ${n.getMaxPlayers()}`,plugins:t,minecraftVersion:n.getVersion(),bukkitVersion:n.getBukkitVersion(),onlineMode:n.getOnlineMode()},java:{version:u.getProperty("java.version"),vendor:u.getProperty("java.vendor"),vendorUrl:u.getProperty("java.vendor.url"),home:u.getProperty("java.home"),command:u.getProperty("sun.java.command"),timezone:u.getProperty("user.timezone")},system:{os:{name:u.getProperty("os.name"),version:u.getProperty("os.version"),arch:u.getProperty("os.arch")},cpu:{cores:m.getRuntime().availableProcessors()},memory:{free:m.getRuntime().freeMemory(),max:m.getRuntime().maxMemory()==e.MAX_VALUE?"unlimited":m.getRuntime().maxMemory(),total:m.getRuntime().totalMemory()},storage:{free:i==null?void 0:i.getFreeSpace(),total:i==null?void 0:i.getTotalSpace(),usable:i==null?void 0:i.getUsableSpace()}}}};let E={};"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".split("").forEach(function(e,n){E[e]=n});function A(e){let n=[],i=0,t=0;for(let a=0;a<e.length;a+=1){let o=E[e[a]];if(o===void 0)throw new Error("Invalid character ("+e[a]+")");const s=o&32;if(o&=31,t+=o<<i,s)i+=5;else{const c=t&1;t>>>=1,c?n.push(t===0?-2147483648:-t):n.push(t),t=i=0}}return n}function V(e){const i=e.mappings.split(";").map(t=>t.split(",")).map(t=>t.map(a=>A(a)));return{sources:e.sources,mappings:i,startOffset:0}}function _(e){const n=JSON.parse(e);return V(n)}const T=new Map;function D(e,n,i){const t=_(n);return t?(t.startOffset=i,T.set(e,t),!0):!1}function U({mappings:e,sources:n},i){let t=0,a=0,o=0;for(let s=0;s<e.length;s++)if(e[s].forEach(l=>{t+=l[2]??0,a+=l[1]??0}),s+1===i)return o=t+1,{file:n[a],line:o};throw new Error(`source map failed for line ${i}`)}function B(e,n){const i=T.get(`${e}`);if(i){if(n-=i.startOffset,n<=0)return{file:e,line:n};const t=U(i,n);return t.file.startsWith("webpack://test/")&&(t.file=t.file.replace("webpack://test/","")),t.file.startsWith("../")&&(t.file=t.file.replace("../","./")),t}else return{file:e,line:n}}const S=Java.type("org.bukkit.Bukkit"),R=Java.type("net.kyori.adventure.text.minimessage.MiniMessage"),P="      ",W=["yamjs.Interop.catchError","com.oracle.truffle.polyglot.PolyglotFunctionProxyHandler.invoke","jdk.proxy1.$Proxy75.run"],G=["webpack/runtime/make"],X=["catchAndLogUnhandledErrors"],q=e=>{const n=[];n.push(e.name);for(let i=0;i<e.stack.length;i++){const t=e.stack[i];if(t.javaFrame){if(W.includes(`${t.source}.${t.methodName}`))continue;n.push(`${P}at ${t.source}.${t.methodName}(${t.fileName}:${t.line})`);continue}const a=B(t.source,t.line);if(G.some(s=>a.file.includes(s))||X.includes(t.methodName)||a.line===0)continue;let o=t.methodName||"<anonymous>";t.methodName===":=>"&&(o="<anonymous>"),n.push(`${P}at ${o} (${a.file}:${a.line}) [${t.source}:${t.line}]`)}return n.join(`
`)},k=(e,n)=>{var t,a,o;let i;try{const s=((o=(a=(t=e==null?void 0:e.getClass)==null?void 0:t.call(e))==null?void 0:a.getName)==null?void 0:o.call(a))??void 0;s!=null&&s.includes("yamjs.JsError")?i=e:i=__interop.catchError(()=>{throw e});const c=q(i);n&&S.getConsoleSender().sendMessage(n),S.getConsoleSender().sendMessage(R.miniMessage().deserialize(`<red>${c}</red>`))}catch(s){console.log("ERROR: There was an error logging an error. Please report to YamJS. ",s.name),console.log(s.message,s.stack),console.log("Original error: ",e==null?void 0:e.name),console.log(e==null?void 0:e.message,e==null?void 0:e.stack)}},I=(e,n)=>{try{return e()}catch(i){k(i,n)}},K=(e,n)=>(...i)=>{try{return e(...i)}catch(t){k(t,n)}},Q=Java.type("org.bukkit.event.EventPriority"),Z=Java.type("org.bukkit.event.Listener"),L=()=>new(Java.extend(Z,{})),$=L(),ee=(e,n,i="HIGHEST",t=$)=>{const a={priority:"priority"in n?n.priority:i,script:"script"in n?n.script:n},o=e.class.toString();h.registerEvent(e.class,t,Q.valueOf(a.priority),(s,c)=>{c instanceof e&&I(()=>{a.script(c)},`An error occured while attempting to handle the "${o}" event!`)},f)};let v;const b=(...e)=>{v===void 0&&(v=Yam.getConfig().verbose),v&&console.log(...e)},j=Symbol("TickContext"),te=()=>{const e=p[j];if(e.isActive){for(const n of e.tickFns)n(e.tick);e.tick%20===0&&b("Tick",e.tick),e.tick+=1}},p=(()=>{const e={tick:0,task:void 0,isActive:!1,tickFns:[]},n=()=>{e.isActive=!0,Yam.instance.setTickFn(te)},i=async()=>{e.isActive=!1};return{[j]:e,start:n,stop:i,getTick:()=>e.tick,registerTickFn:t=>{e.tickFns.push(t)}}})(),ne=e=>e,ie=e=>e,M=(()=>{const e={nextId:0},n=new Map,i=s=>{n.delete(s)},t=(s,c,l)=>{const d=ie((l==null?void 0:l.nextId)??e.nextId++),ce=ne(p.getTick()+Math.max(c,1));return n.set(d,{baseTick:c,tick:ce,fn:s,reset:(l==null?void 0:l.reset)||!1,id:d}),d},a=s=>{n.delete(s.id),s.fn(),s.reset&&t(s.fn,s.baseTick,{reset:s.reset,nextId:s.id})},o=s=>{for(const[,c]of n)s>=c.tick&&a(c)};return{add:t,run:o,remove:i,initialize:()=>{p.registerTickFn(s=>o(s))}}})(),x=(e,n,i)=>{const t=n/50;return M.add(K(e,"Unhandled timer"),t,i)},F=(e,n)=>x(e,n),se=(e,n)=>x(e,n,{reset:!0}),oe=e=>F(e,0),w=e=>M.remove(e),ae=()=>{globalThis.setTimeout=F,globalThis.setInterval=se,globalThis.setImmediate=oe,globalThis.clearTimeout=w,globalThis.clearInterval=w},J=Symbol("lifecycle"),y=(()=>{const e=new Map;let n=0;const i=async t=>{const a=e.get(t);for(let o=1;o<=5;o++){const s=[...a.values()].filter(c=>c.priority===o);for(const{hook:c,name:l}of s){l&&console.log(`${t==="onEnable"?"Enabling":"Disabling"} ${l}`);try{await(c==null?void 0:c())}catch(d){console.error(d)}}}e.delete(t)};return Yam.instance.setOnCloseFn(async()=>{await i("onDisable")}),{[J]:{executeHooks:i},reload:async()=>{b("Reloading YamJS"),await i("onDisable"),Yam.reload(),b("Finished reloading YamJS")},register:(t,a)=>{const o=n++,s=e.get(t)??new Map;return s.set(o,{priority:3,...a}),e.set(t,s),()=>delete s[o]}}})(),N=Java.type("org.bukkit.event.HandlerList");let Y=!1;const C=()=>{Y||(p.start(),M.initialize(),ae(),Yam.instance.setLoggerFn(e=>k(e)),Yam.getMeta()==="yamjs"?y.register("onDisable",{name:"Event Listeners",hook:()=>{N.unregisterAll(f)},priority:5}):y.register("onDisable",{name:"Context Event Listeners",hook:()=>{N.unregisterAll($)},priority:5}),y[J].executeHooks("onEnable"),Y=!0)};Yam.getConfig().initialize&&C(),r.bukkitManager=h,r.bukkitPlugin=f,r.bukkitServer=z,r.cacheSourceMap=D,r.catchAndLogUnhandledError=I,r.createEventListener=L,r.getDebugInfo=O,r.initialize=C,r.lifecycle=y,r.logError=k,r.registerEvent=ee,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
